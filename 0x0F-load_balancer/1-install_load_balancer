#!/usr/bin/env bash

# Install HAProxy
sudo apt-get update
sudo apt-get install -y haproxy

# Configure HAProxy
cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg >/dev/null
global
    daemon
    maxconn 256

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http-in
    bind *:80
    default_backend webservers

backend webservers
    mode http
    balance roundrobin
    server 151938-web-01 54.237.56.192:80 check
    server 151938-web-02 54.146.65.87:80 check
EOF

# Enable and start HAProxy service
sudo systemctl enable haproxy
sudo systemctl start haproxy

# Manage HAProxy via an init script
cat <<EOF | sudo tee /etc/systemd/system/haproxy.service >/dev/null
[Unit]
Description=HAProxy Load Balancer
After=network.target

[Service]
ExecStart=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg
ExecReload=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -sf \$(cat /run/haproxy.pid)
KillMode=mixed

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and start HAProxy
sudo systemctl daemon-reload
sudo systemctl enable haproxy
sudo systemctl start haproxy

# Test HAProxy
cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg >/dev/null
listen stats
    bind *:8080
    stats enable
    stats uri /haproxy-stats
    stats refresh 5s
EOF

# Reload HAProxy
sudo systemctl reload haproxy

